# UniConv

é«˜æ€§èƒ½C++å­—ç¬¦ç¼–ç è½¬æ¢åº“ï¼Œæä¾›ç°ä»£åŒ–C++17æ¥å£å’Œæ— é”å¹¶å‘æ¶æ„ã€‚

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![C++17](https://img.shields.io/badge/C++-17-blue.svg)](https://isocpp.org/)
[![CMake](https://img.shields.io/badge/CMake-3.16%2B-green.svg)](https://cmake.org/)

UniConv æ˜¯ GNU libiconv çš„ç°ä»£ C++17 å°è£…ï¼Œå…·æœ‰é›¶æ‹·è´ä¼˜åŒ–ã€æ— é”å¹¶å‘ç¼“å­˜å’Œé«˜æ€§èƒ½æ‰¹å¤„ç†èƒ½åŠ›ã€‚

## æ ¸å¿ƒç‰¹æ€§

### æ€§èƒ½ä¸æ¶æ„
- **æ— é”å¹¶å‘ç¼“å­˜**: é‡‡ç”¨ parallel-hashmap å®ç°çš„æ— é” iconv æè¿°ç¬¦ç¼“å­˜
  - 4-way å¹¶è¡Œ (16ä¸ªå­æ˜ å°„)ï¼Œæ˜¾è‘—å‡å°‘é”ç«äº‰
  - æ”¯æŒå¤šçº¿ç¨‹åŒæ—¶è¯»å†™ï¼Œæ— å…¨å±€é˜»å¡
  - çº¿ç¨‹å®‰å…¨çš„ LRU é€å‡ºç­–ç•¥
- **é›¶æ‹·è´è½¬æ¢**: BufferLease æœºåˆ¶å®ç°é›¶æ‹·è´å†…å­˜ç®¡ç†
- **é«˜æ€§èƒ½æ‰¹å¤„ç†**: å¹¶è¡Œæ‰¹é‡è½¬æ¢ï¼Œæœ€é«˜ 1.94x æ€§èƒ½æå‡
- **ç°ä»£ C++17 API**: åŸºäº RAII çš„èµ„æºç®¡ç†ï¼Œstring_view æ”¯æŒ

### åŠŸèƒ½ç‰¹æ€§
- **çº¿ç¨‹å®‰å…¨**: åŸç”Ÿå¤šçº¿ç¨‹æ”¯æŒï¼Œæ— éœ€å¤–éƒ¨åŒæ­¥
- **é›¶å¤–éƒ¨ä¾èµ–**: å†…åµŒ GNU libiconv å’Œ parallel-hashmap
- **è·¨å¹³å°**: æ”¯æŒ Windowsã€Linux å’Œ macOS
- **100+ ç¼–ç **: æ”¯æŒ Unicodeã€äºšæ´²å’Œæ¬§æ´²å­—ç¬¦é›†
- **é”™è¯¯å¤„ç†**: CompactResult ç±»å‹æä¾›æ¸…æ™°çš„é”™è¯¯å¤„ç†

## æ€§èƒ½åŸºå‡†

### å•æ¬¡è½¬æ¢æ€§èƒ½
```text
ConvertEncodingFast:         434 ns/op  (230ä¸‡ ops/s)
ConvertEncodingFastWithHint: 358 ns/op  (280ä¸‡ ops/s)
ä¼ ç»Ÿæ–¹æ³•:                    810 Î¼s/1000æ¬¡  (123ä¸‡ ops/s)
æ€§èƒ½æå‡:                    1.77x - 2.35x
```

### æ‰¹é‡è½¬æ¢æ€§èƒ½
```text
å¹¶è¡Œæ‰¹å¤„ç† (10ä¸ªæ–‡æœ¬):       1.94x æ€§èƒ½æå‡
å¤§æ–‡æœ¬æ‰¹å¤„ç† (100KB+):       1.89x æ€§èƒ½æå‡
```

### æ— é”ç¼“å­˜ä¼˜åŠ¿
- **å‡å°‘é”ç«äº‰**: 16ä¸ªå­æ˜ å°„ç‹¬ç«‹åŠ é”
- **æå‡ååé‡**: å¤šçº¿ç¨‹åŒæ—¶è®¿é—®ä¸åŒå­æ˜ å°„
- **é™ä½å»¶è¿Ÿ**: æ— å…¨å±€å†™é”é˜»å¡è¯»æ“ä½œ

## æ”¯æŒçš„ç¼–ç 

- **Unicode**: UTF-8, UTF-16LE/BE, UTF-32LE/BE
- **ä¸­æ–‡**: GBK, GB2312, GB18030, Big5
- **æ—¥æ–‡**: Shift-JIS, EUC-JP, ISO-2022-JP
- **æ¬§æ´²**: ISO-8859-1~15, Windows-1252
- **100+ç§**: è¯¦è§æ–‡æ¡£å®Œæ•´åˆ—è¡¨

## å¿«é€Ÿå¼€å§‹ 

### ç³»ç»Ÿè¦æ±‚

- æ”¯æŒC++17çš„ç¼–è¯‘å™¨
- CMake 3.16æˆ–æ›´é«˜ç‰ˆæœ¬
- Windowsã€Linuxæˆ–macOS

### å®‰è£…

#### ä½¿ç”¨vcpkgï¼ˆæ¨èï¼‰

```bash
vcpkg install uniconv
```

#### ä½¿ç”¨CMake FetchContent

```cmake
include(FetchContent)
FetchContent_Declare(
    UniConv
    GIT_REPOSITORY https://github.com/hesphoros/UniConv.git
    GIT_TAG        main
)
FetchContent_MakeAvailable(UniConv)

target_link_libraries(your_target PRIVATE UniConv)
```

#### æ‰‹åŠ¨æ„å»º

```bash
git clone https://github.com/hesphoros/UniConv.git
cd UniConv
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
cmake --build . --config Release
```

#### å¯ç”¨ SIMD åŠ é€Ÿï¼ˆå¯é€‰ï¼‰

UniConv æ”¯æŒé€šè¿‡ [simdutf](https://github.com/simdutf/simdutf) åº“å®ç° SIMD åŠ é€Ÿçš„ UTF è½¬æ¢ã€‚è¿™æ˜¯å¯é€‰åŠŸèƒ½ï¼Œé»˜è®¤å…³é—­ã€‚

```bash
# å¯ç”¨ simdutf SIMD åŠ é€Ÿï¼ˆé€šè¿‡ FetchContent è‡ªåŠ¨ä¸‹è½½ï¼‰
cmake .. -DCMAKE_BUILD_TYPE=Release -DUNICONV_USE_SIMDUTF=ON
cmake --build . --config Release
```

**SIMD åŠ é€Ÿæ”¯æŒçš„ç¼–ç è½¬æ¢**ï¼š
- UTF-8 â†” UTF-16LE
- UTF-8 â†” UTF-16BE

**é¢„æœŸæ€§èƒ½æå‡**ï¼šASCII ä¸»å¯¼æ–‡æœ¬ 5-15x æ€§èƒ½æå‡

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬è½¬æ¢

```cpp
#include "UniConv.h"

int main() {
    auto conv = UniConv::GetInstance();
    
    // åŸºç¡€è½¬æ¢ - GBKè½¬UTF-8
    std::string output;
    bool success = conv->ConvertEncoding("ä¸­æ–‡æµ‹è¯•", "GBK", "UTF-8", output);
    
    if (success) {
        std::cout << output << std::endl;
    }
    
    return 0;
}
```

### ä½¿ç”¨ CompactResult è¿›è¡Œé”™è¯¯å¤„ç†

```cpp
auto result = conv->ConvertEncodingFast("æµ‹è¯•æ–‡æœ¬", "GBK", "UTF-8");

if (result.IsSuccess()) {
    std::cout << "è½¬æ¢æˆåŠŸ: " << result.GetValue() << std::endl;
} else {
    std::cerr << "è½¬æ¢å¤±è´¥: " << static_cast<int>(result.GetError()) << std::endl;
}
```

### é›¶æ‹·è´è½¬æ¢ï¼ˆä½¿ç”¨ BufferLeaseï¼‰

```cpp
// è·å–ç¼“å†²åŒº
auto lease = conv->ConvertEncodingWithLease("å¤§é‡æ–‡æœ¬æ•°æ®", "GBK", "UTF-8");

if (lease.IsSuccess()) {
    // é›¶æ‹·è´è®¿é—®ç»“æœ
    std::string_view result = lease.GetValue();
    ProcessData(result);  // å¤„ç†æ•°æ®
    
    // lease ææ„æ—¶è‡ªåŠ¨å½’è¿˜ç¼“å†²åŒºåˆ°æ± 
}
```

### æ‰¹é‡è½¬æ¢

```cpp
// æ‰¹é‡è½¬æ¢
std::vector<std::string> texts = {"æ–‡æœ¬1", "æ–‡æœ¬2", "æ–‡æœ¬3"};  
auto results = conv->ConvertEncodingBatch(texts, "GBK", "UTF-8");

for (const auto& result : results) {
    if (result.IsSuccess()) {
        std::cout << result.GetValue() << std::endl;
    }
}
```

### å¹¶è¡Œæ‰¹å¤„ç†ï¼ˆé«˜æ€§èƒ½ï¼‰

```cpp
// å¹¶è¡Œæ‰¹é‡è½¬æ¢ï¼Œè‡ªåŠ¨åˆ©ç”¨å¤šæ ¸CPU
std::vector<std::string> large_dataset = LoadLargeDataset();
auto results = conv->ConvertEncodingBatchParallel(
    large_dataset, 
    "GBK", 
    "UTF-8",
    std::thread::hardware_concurrency()  // ä½¿ç”¨æ‰€æœ‰å¯ç”¨æ ¸å¿ƒ
);

// 1.94x æ€§èƒ½æå‡ï¼ˆç›¸æ¯”é¡ºåºå¤„ç†ï¼‰
```

### string_view æ”¯æŒï¼ˆé›¶æ‹·è´è¾“å…¥ï¼‰

```cpp
std::string_view input = GetLargeText();  // æ— éœ€æ‹·è´
std::string output;

// ç›´æ¥ä½¿ç”¨ string_viewï¼Œé¿å…è¾“å…¥æ‹·è´
conv->ConvertEncoding(input, "GBK", "UTF-8", output);
```

## API å‚è€ƒ

### æ ¸å¿ƒè½¬æ¢ API

```cpp
// åŸºç¡€è½¬æ¢ï¼ˆè¾“å‡ºå‚æ•°ï¼‰
bool ConvertEncoding(const std::string& input, 
                     const char* fromEncoding, 
                     const char* toEncoding, 
                     std::string& output);

bool ConvertEncoding(std::string_view input,  // é›¶æ‹·è´è¾“å…¥
                     const char* fromEncoding, 
                     const char* toEncoding, 
                     std::string& output);

// è¿”å› CompactResult
CompactResult<std::string> ConvertEncodingFast(
    const std::string& input,
    const char* fromEncoding,
    const char* toEncoding
);

// é›¶æ‹·è´è¾“å‡ºï¼ˆBufferLeaseï¼‰
BufferLease ConvertEncodingWithLease(
    const std::string& input,
    const char* fromEncoding,
    const char* toEncoding
);
```

### æ‰¹é‡å¤„ç† API

```cpp
// é¡ºåºæ‰¹å¤„ç†
std::vector<CompactResult<std::string>> ConvertEncodingBatch(
    const std::vector<std::string>& inputs,
    const char* fromEncoding,
    const char* toEncoding
);

// å¹¶è¡Œæ‰¹å¤„ç†ï¼ˆæ¨èç”¨äºå¤§æ‰¹é‡ï¼‰
std::vector<CompactResult<std::string>> ConvertEncodingBatchParallel(
    const std::vector<std::string>& inputs,
    const char* fromEncoding,
    const char* toEncoding,
    size_t num_threads = 0  // 0 = è‡ªåŠ¨æ£€æµ‹
);
```

### ç¼“å­˜ç»Ÿè®¡ API

```cpp
struct PoolStats {
    size_t active_buffers;          // æ´»è·ƒç¼“å†²åŒºæ•°é‡
    size_t total_conversions;       // æ€»è½¬æ¢æ¬¡æ•°
    size_t cache_hits;              // ç¼“å­˜å‘½ä¸­æ¬¡æ•°
    double hit_rate;                // å‘½ä¸­ç‡
    size_t iconv_cache_size;        // iconvç¼“å­˜å¤§å°
    size_t iconv_cache_hits;        // iconvç¼“å­˜å‘½ä¸­
    size_t iconv_cache_misses;      // iconvç¼“å­˜æœªå‘½ä¸­
    size_t iconv_cache_evictions;   // iconvç¼“å­˜é€å‡º
};

PoolStats GetPoolStatistics() const;
```

## æŠ€æœ¯æ¶æ„

### æ— é”å¹¶å‘ç¼“å­˜
- **parallel-hashmap**: Google Abseil è¡ç”Ÿçš„é«˜æ€§èƒ½å¹¶å‘å“ˆå¸Œè¡¨
- **4-way å¹¶è¡Œ**: 16ä¸ªå­æ˜ å°„ï¼Œå‡å°‘ 16x é”ç«äº‰
- **ç»†ç²’åº¦é”å®š**: æ¯ä¸ªå­æ˜ å°„ç‹¬ç«‹åŠ é”
- **çº¿ç¨‹å®‰å…¨ LRU**: æ— é”è¿­ä»£ + åŸå­æ“ä½œ

### é›¶æ‹·è´ä¼˜åŒ–
- **BufferLease**: RAII é£æ ¼çš„ç¼“å†²åŒºç§Ÿçº¦
- **å¯¹è±¡æ± ç®¡ç†**: é¢„åˆ†é…ç¼“å†²åŒºï¼Œå‡å°‘å†…å­˜åˆ†é…
- **string_view è¾“å…¥**: é¿å…è¾“å…¥æ•°æ®æ‹·è´
- **ç§»åŠ¨è¯­ä¹‰**: å……åˆ†åˆ©ç”¨ C++17 ç§»åŠ¨ä¼˜åŒ–

### æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯
- **çº¿ç¨‹å±€éƒ¨ç¼“å­˜**: æ¯çº¿ç¨‹ç‹¬ç«‹ iconv æè¿°ç¬¦ç¼“å­˜
- **åˆ†æ”¯é¢„æµ‹æç¤º**: LIKELY/UNLIKELY å®ä¼˜åŒ–
- **ç¼“å­˜é¢„å–**: æå‰åŠ è½½æ•°æ®åˆ° CPU ç¼“å­˜
- **å†…å­˜å¯¹é½**: ä¼˜åŒ–ç¼“å­˜è¡Œè®¿é—®

## æ„å»ºå’Œæµ‹è¯•

### æ„å»ºé€‰é¡¹

```bash
# æ ‡å‡†æ„å»º
cmake .. -DCMAKE_BUILD_TYPE=Release

# åŒ…å«æµ‹è¯•
cmake .. -DUNICONV_BUILD_TESTS=ON

# åŒ…å«ç¤ºä¾‹
cmake .. -DBUILD_EXAMPLES=ON
```

### è¿è¡Œæµ‹è¯•

```bash
cd build
cmake --build . --config Release

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
./bin/UniConvTests

# è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
./bin/PerformanceBenchmark

# è¿è¡Œç¼“å­˜ç»Ÿè®¡æµ‹è¯•
./bin/CacheStatsTest
```

## ä¾èµ–åº“

### å†…åµŒåº“ï¼ˆæ— éœ€å¤–éƒ¨å®‰è£…ï¼‰
- **GNU libiconv**: æ ¸å¿ƒç¼–ç è½¬æ¢å¼•æ“
- **parallel-hashmap**: æ— é”å¹¶å‘å“ˆå¸Œè¡¨
  - é¡¹ç›®åœ°å€: [greg7mdp/parallel-hashmap](https://github.com/greg7mdp/parallel-hashmap)
  - åŸºäº Google Abseil Swiss Tables
  - Header-onlyï¼Œæ— éœ€ç¼–è¯‘

### ç³»ç»Ÿè¦æ±‚
- C++17 ç¼–è¯‘å™¨
- CMake 3.16+
- Windows / Linux / macOS

## è´¡çŒ®

æ¬¢è¿è´¡çŒ®ï¼è¯·éšæ—¶æäº¤Pull Requestã€‚å¯¹äºé‡å¤§å˜æ›´ï¼Œè¯·å…ˆå¼€issueè®¨è®ºã€‚

1. Forkä»“åº“
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. æ‰“å¼€Pull Request

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## è‡´è°¢

- åŸºäº GNU libiconv æä¾›æ ¸å¿ƒè½¬æ¢åŠŸèƒ½
- é‡‡ç”¨ parallel-hashmap å®ç°æ— é”å¹¶å‘ç¼“å­˜
- éµå¾ªç°ä»£ C++ æœ€ä½³å®è·µå’Œæ€§èƒ½ä¼˜åŒ–æŠ€æœ¯

## æ›´æ–°æ—¥å¿—

### v2.0 (2025-12)
- âœ¨ å®ç°æ— é”å¹¶å‘ç¼“å­˜ï¼ˆparallel-hashmapï¼‰
- âœ¨ æ·»åŠ é›¶æ‹·è´ BufferLease æœºåˆ¶
- âœ¨ å®ç°å¹¶è¡Œæ‰¹å¤„ç† API
- âœ¨ æ·»åŠ  string_view é‡è½½
- ğŸš€ æ€§èƒ½æå‡ï¼šå•æ¬¡è½¬æ¢ 1.77xï¼Œæ‰¹å¤„ç† 1.94x
- ğŸ“ å®Œæ•´çš„ API æ–‡æ¡£å’Œç¤ºä¾‹

### v1.0
- åˆå§‹ç‰ˆæœ¬
- åŸºç¡€ç¼–ç è½¬æ¢åŠŸèƒ½
- çº¿ç¨‹å®‰å…¨æ”¯æŒ

## è®¸å¯ä¸ç¬¬ä¸‰æ–¹ç»„ä»¶å£°æ˜

- æœ¬é¡¹ç›®ä¸»ä½“ä»£ç ç”± `hesphoros` ä»¥ MIT è®¸å¯è¯å‘å¸ƒï¼ˆè§ `LICENSE`ï¼‰ã€‚
- æœ¬ä»“åº“åŒ…å« GNU libiconv çš„æºä»£ç ï¼ˆè§ `src/` ç›®å½•ä¸­çš„ `iconv.c`ã€`localcharset.c` ç­‰æ–‡ä»¶ï¼‰ã€‚
    libiconv æºä»£ç éµå¾ª **GNU Lesser General Public License (LGPL) v2.1 æˆ–æ›´é«˜ç‰ˆæœ¬**ã€‚

ä¸ºéµå®ˆå¼€æºè®¸å¯ï¼š

- ä»“åº“ä¸­åŒ…å« `COPYING.LIB`ï¼Œè¯´æ˜ libiconv çš„è®¸å¯è¯åŠåˆè§„è¦ç‚¹ï¼›
- ä»“åº“ä¸­åŒ…å« `THIRD_PARTY_LICENSES.md`ï¼Œåˆ—å‡ºå·²åŒ…å«çš„ç¬¬ä¸‰æ–¹ä»£ç ä»¥åŠåˆ†å‘æ—¶éœ€è¦æ³¨æ„çš„åˆè§„æ“ä½œï¼›
- å¦‚æœä½ è¦åˆ†å‘é™æ€é“¾æ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå³å°† libiconv æºç›´æ¥åˆå¹¶è¿›å¯æ‰§è¡Œæ–‡ä»¶ï¼‰ï¼Œä½ éœ€è¦éµå®ˆ LGPL è¦æ±‚ï¼ˆä¿ç•™ç‰ˆæƒã€æä¾›ä¿®æ”¹åçš„ libiconv æºæˆ–æä¾›å¯é‡é“¾æ¥çš„å¯¹è±¡æ–‡ä»¶ç­‰ï¼‰ã€‚

å¦‚æœä½ å¸Œæœ›å®Œå…¨é¿å… LGPL çš„çº¦æŸï¼Œæ¨èçš„åšæ³•æ˜¯ï¼š

1. ä½¿ç”¨ç³»ç»Ÿæä¾›çš„ libiconvï¼ˆåŠ¨æ€é“¾æ¥ï¼‰ï¼Œæˆ–è€…
2. åœ¨æ„å»ºæ—¶å°† libiconv ä½œä¸ºå•ç‹¬å¯æ›¿æ¢çš„å­é¡¹ç›®/é™æ€åº“ï¼Œè®©ä½¿ç”¨è€…å¯ä»¥ç”¨è‡ªå·±çš„ libiconv æºæˆ–äºŒè¿›åˆ¶æ›¿æ¢ï¼Œæˆ–
3. ç§»é™¤å†…åµŒçš„ libiconvï¼Œæ”¹ç”¨è®¸å¯è¯å…¼å®¹çš„å®ç°ï¼ˆè‹¥å­˜åœ¨ï¼‰ã€‚

æ›´å¤šç»†èŠ‚è¯·å‚è§ `COPYING.LIB` ä¸ `THIRD_PARTY_LICENSES.md`ã€‚
