\chapter{iconv}
\hypertarget{md_doc_2iconv}{}\label{md_doc_2iconv}\index{iconv@{iconv}}

\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keyword}{namespace\ }UniConvfunc\{}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//转换结构}}
\DoxyCodeLine{\textcolor{keyword}{struct\ }IConvResult\ \{}
\DoxyCodeLine{\ \ \ \ std::string\ \ \ \ \ \ \ \ result;\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ 转换成功的结果\ 使用新编码的字符串}}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{int}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ error\_code\ \ =\ 0\ ;\ \textcolor{comment}{//\ 错误码}}
\DoxyCodeLine{\ \ \ \ std::string\ \ \ \ \ \ \ \ error\_msg;\ \ \ \ \ \ \ \ \textcolor{comment}{//\ 错误信息}}
\DoxyCodeLine{\};}
\DoxyCodeLine{IConvResult\ Convert(std::string\_view\ in,\ \textcolor{keywordtype}{char}\ \textcolor{keyword}{const}\ *\ fromcode,\textcolor{keywordtype}{char}\ \textcolor{keyword}{const}*\ tocode)\ \{}
\DoxyCodeLine{\ \ \ \ IConvResult\ iconv\_result;}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{//打开iconv\ 转换描述符}}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{iconv_8h_a394d3fb485b2577035dd4a8055724273}{iconv\_t}}\ cd\ =\ \mbox{\hyperlink{iconv_8h_abc93f77b3b8b5891765c9f3c483ec013}{iconv\_open}}(tocode,\ fromcode);}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordflow}{if}\ (cd\ ==\ \textcolor{keyword}{reinterpret\_cast<}\mbox{\hyperlink{iconv_8h_a394d3fb485b2577035dd4a8055724273}{iconv\_t}}\textcolor{keyword}{>}(-\/1))\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ iconv\_result.error\_code\ =\ errno;}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keywordflow}{switch}\ (iconv\_result.error\_code)\{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ EINVAL:}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//不完整的多字节序列\ or\ \ 不支持的编码}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ iconv\_result.error\_msg\ =\ \textcolor{stringliteral}{"{}Conversion\ not\ supported\ between\ the\ specified\ encodings"{}};;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ ENOMEM:}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ 内存不足}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ iconv\_result.error\_msg\ =\ \textcolor{stringliteral}{"{}Out\ of\ memory"{}};}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ iconv\_result.error\_msg\ =\ \textcolor{stringliteral}{"{}Unknown\ error"{}};}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ iconv\_result;}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{char}*\ \ \ \ \ \ \ \ inBufferPtr\ =\ \textcolor{keyword}{const\_cast<}\textcolor{keywordtype}{char}*\textcolor{keyword}{>}(in.data());\textcolor{comment}{//指向输入缓存位置(非常量}}
\DoxyCodeLine{\ \ \ \ std::size\_t\ \ inBytesLeft\ =\ in.size();\textcolor{comment}{//输入缓存的大小}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ }
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ std::stringstream\ ss;}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ std::size\_t\ \textcolor{keyword}{const}\ sizeOfOutbuffer\ =\ 4096;\textcolor{comment}{//固定大小的输出缓冲区大小}}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{char}\ \ \ \ \ \ \ \ outBuffer[sizeOfOutbuffer];\textcolor{comment}{//输出缓存}}
\DoxyCodeLine{}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordflow}{while}\ (inBytesLeft\ >\ 0\ )\textcolor{comment}{//\ 输入缓存中,还有剩余字符未被转换}}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}*\ \ \ \ \ \ \ \ \ outBufferPtr\ \ =\ outBuffer;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ std::size\_t\ \ \ outBufferLeft\ =\ sizeOfOutbuffer;}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{comment}{//执行转换\ //\ 在iconv\ 中会修改buffer有多少个字节没有被使用}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ std::size\_t\ ret\ =\ \mbox{\hyperlink{iconv_8h_a44c0f9426dd91c55d783618e535404b7}{iconv}}(cd,\ (\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}**)\ \&\ inBufferPtr,\ \&inBytesLeft,\ \&outBufferPtr,\ \&outBufferLeft);}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (ret\ ==\ (std::size\_t)(-\/1))\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ 转换停止\ or\ 错误}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ n\ =\ errno;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{switch}\ (n)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ E2BIG:}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{iconv_8h_ac6c071293826a4e66a717bb38db7794d}{EILSEQ}}:}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//输入字符序列不符合编码规则}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ iconv\_result.error\_msg\ =\ \textcolor{stringliteral}{"{}Invalid\ multibyte\ sequence"{}};}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ iconv\_result.error\_code\ =\ errno;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ EINVAL:}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//输入的字符序列不完整}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ iconv\_result.error\_code\ =\ errno;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ iconv\_result.error\_msg\ =\ \textcolor{stringliteral}{"{}Incomplete\ character\ sequence"{}};}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ iconv\_result.error\_code\ =\ errno;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ iconv\_result.error\_msg\ =\ \textcolor{stringliteral}{"{}Unknown\ conversion\ error"{}};}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (iconv\_result.error\_code\ !=\ 0)\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//跳出循环}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ }
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{comment}{//将本轮的输出结果，写入输出流}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ ss.write(outBuffer,\ sizeOfOutbuffer\ -\/\ outBufferLeft);}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{iconv_8h_a0c4ff4bdefbf1576f3e7bab5fbc5ec89}{iconv\_close}}(cd);}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordflow}{if}\ (iconv\_result.error\_code\ ==\ 0)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ iconv\_result.result\ =\ ss.str();}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordflow}{return}\ iconv\_result;}
\DoxyCodeLine{\}}
\DoxyCodeLine{\}}

\end{DoxyCode}


\href{https://www.gnu.org/savannah-checkouts/gnu/libiconv/documentation/libiconv-1.18/iconv_open.3.html}{\texttt{ https\+://www.\+gnu.\+org/savannah-\/checkouts/gnu/libiconv/documentation/libiconv-\/1.\+18/iconv\+\_\+open.\+3.\+html}} 